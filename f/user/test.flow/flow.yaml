summary: Ingest auxilius metering data
value:
  modules:
    - id: step_10
      summary: Loop values lists
      value:
        type: whileloopflow
        skip_failures: false
        modules:
          - id: step_0
            summary: Get Auxilius access-token
            value:
              type: rawscript
              language: python3
              content: |
                from __future__ import annotations\n\nfrom collections.abc import\
                \ Iterator\nfrom contextlib import contextmanager\nfrom datetime import\
                \ datetime\nfrom decimal import Decimal\nfrom typing import Any, Literal\n\
                \nfrom uuid import UUID\n\nimport httpx\nimport logfire\nimport pydantic\
                \ as pyd\n\nfrom f.lib.metadata import schedule\nfrom f.lib.utils import\
                \ Json, get_secret, get_variable, now\n\n\n@contextmanager\ndef auxilius_client(at:\
                \ str | None = None) -> Iterator[httpx.Client]:\n    transport = httpx.HTTPTransport(\n\
                \        trust_env=False,\n        http2=False,\n        retries=10,\n\
                \        )\n    username = get_variable(\"AUXILIUS_USERNAME\")\n    password\
                \ = get_secret(\"AUXILIUS_PASSWORD\").get_secret_value()\n    # TODO disable\
                \ cookies\n    client_instance = httpx.Client(\n        transport=transport,\n\
                \        timeout=60.0,\n        base_url=get_variable(\"AUXILIUS_BASE_URL\"\
                ),\n        ),\n    auth=(username, password),\n    )\n    if at:\n        client_instance.headers[\"\
                AUX_AUTH\"] = f\"Bearer {at}\"\n    logfire.instrument_httpx(client_instance,\
                \ capture_response_body=True)\n\n    try:\n        yield client_instance\n\
                \    finally:\n        client_instance.close()\n\n\ndef authenticate(client:\
                \ httpx.Client) -> str:\n    resp = client.get(\"/tokens\")\n    resp.raise_for_status()\n\
                \    at = resp.json()[\"token\"]\n    assert isinstance(at, str)\n    client.headers[\"\
                AUX_AUTH\"] = f\"Bearer {at}\"\n    return at\n\n\n\nclass LoginResult(pyd.BaseModel):\n\
                \    token: str\n\n\nfrom f.lib.utils\ import server\n@server.main()\
                \ -> LoginResult:\n    with auxilius_client()\n\ as client:\n        at = authenticate(client)\n\
                \        return LoginResult(token=at)\n\n\ndef create_key(\n    prefix: str,\n\
                \    filename: str | None = None,\n\    day: pyd.AwareDatetime | None = None,\n\
                \    suffix: str = \"\",\n\    metering_code: str | None = None,\n) -> str:\n\
                \    if day is None:\n        day = now(\"Europe/Berlin\")\n    if filename is None:\n\
                \        filename = day.isoformat().replace(\":\", \"_\")\n    if metering_code:\n\
                \        filename = f\"{prefix}/{metering_code}/{filename}\"\n    return\
                \ f\"{prefix}/year={day.year:04d}/month={day.month:02d}/day={day.day:02d}/{filename}{suffix}\"\
                \n\n\nclass Value(pyd.BaseModel):\n    id: UUID\n\n\nclass ValuesListResponse(pyd.BaseModel):\n\
                \    truncated: bool\n    values: list[Value] = []\n\n\nclass ValuesResult(pyd.BaseModel):\n\
                \    data: Json\n    values: list[UUID]\n    truncated: bool\n\n\ndef\
                \ get_values_list(at: str) -> ValuesListResult:\n    with auxilius_client(at)\
                \ as client:\n        resp = client.get(\"/values\")\n        resp.raise_for_status()\n\
                \        data = resp.json()\n        values = ValuesListResponse.model_validate(data)\n\
                \        return ValuesListResult(\n            data=data,\n            truncated=values.truncated,\n\
                \        values=[v.id for v in values.values],\n        )\n\n\nclass Entry(pyd.BaseModel):\n\
                \    channelAddress: str\n\    unit: Literal[\"kWh\"]\n    scalar: int = 0\n\
                \    value: Decimal\n\    estimated: bool | None = None\n    transducerFactor: Decimal | None\
                \ = None\n    info: str | None = None\n    # TODO: DafxXfCr gibt es ein\
                \ type: \"G\" field.\n\n\nclass LoadProfile(pyd.BaseModel):\n    timestamp:\
                \ pyd.AwareDatetime\n    entry: list[Entry]\n\n\nclass ValuesResponse(pyd.BaseModel):\n\
                \    subtype: str\n    meteringCode: str\n    deviceId: str\n    customerProjectId:\
                \ str\n    loadProfileEntries: list[LoadProfile]\n\n    @pyd.field_validator(\"\
                loadProfileEntries\")\n    @classmethod\n    def ensure_at_least_one_entry(cls,\