summary: Ingest auxilius metering data
value:
  modules:
    - id: step_10
      value:
        type: whileloopflow
        modules:
          - id: step_0
            retry:
              constant:
                seconds: 0
                attempts: 0
              exponential:
                seconds: 5
                attempts: 2
                multiplier: 2
                random_factor: 0
            value:
              lock: '!inline get_auxilius_access-token.inline_script.lock'
              type: rawscript
              content: '!inline get_auxilius_access-token.inline_script.py'
              language: python3
              input_transforms: {}
            summary: Get Auxilius access-token
          - id: step_1
            retry:
              constant:
                seconds: 0
                attempts: 0
              exponential:
                seconds: 5
                attempts: 2
                multiplier: 2
                random_factor: 0
            value:
              lock: '!inline get_values_list.inline_script.lock'
              type: rawscript
              content: '!inline get_values_list.inline_script.py'
              language: python3
              input_transforms:
                at:
                  expr: results.step_0.token
                  type: javascript
            summary: Get values list
          - id: step_2
            value:
              lock: '!inline generate_s3_key.inline_script.lock'
              type: rawscript
              content: '!inline generate_s3_key.inline_script.py'
              language: python3
              input_transforms:
                prefix:
                  type: static
                  value: meterdata/provider=auxilius/type=values
                suffix:
                  type: static
                  value: .json.gz
            summary: Generate s3 key
          - id: step_3
            value:
              path: f/scripts/store_s3
              type: script
              input_transforms:
                key:
                  expr: results.step_2
                  type: javascript
                data:
                  expr: results.step_1.data
                  type: javascript
                bucket:
                  expr: flow_input.bucket
                  type: javascript
            summary: Store values list
          - id: step_8
            value:
              type: forloopflow
              modules:
                - id: step_4
                  value:
                    lock: '!inline get_value.inline_script.lock'
                    type: rawscript
                    content: '!inline get_value.inline_script.py'
                    language: python3
                    input_transforms:
                      at:
                        expr: results.step_0.token
                        type: javascript
                      uuid:
                        expr: flow_input.iter.value
                        type: javascript
                  summary: Get value
                - id: step_5
                  value:
                    lock: '!inline generate_s3_key_1.inline_script.lock'
                    type: rawscript
                    content: '!inline generate_s3_key_1.inline_script.py'
                    language: python3
                    input_transforms:
                      day:
                        expr: results.step_4.day
                        type: javascript
                      prefix:
                        type: static
                        value: meterdata/provider=auxilius/type=value
                      suffix:
                        type: static
                        value: .json.gz
                      filename:
                        expr: flow_input.iter.value
                        type: javascript
                      metering_code:
                        expr: results.step_4.meteringCode
                        type: javascript
                  summary: Generate s3 key
                - id: step_6
                  value:
                    path: f/scripts/store_s3
                    type: script
                    input_transforms:
                      key:
                        expr: results.step_5
                        type: javascript
                      data:
                        expr: results.step_4.data
                        type: javascript
                      bucket:
                        expr: flow_input.bucket
                        type: javascript
                  summary: Store value
                - id: step_7
                  retry:
                    constant:
                      seconds: 0
                      attempts: 0
                    exponential:
                      seconds: 5
                      attempts: 2
                      multiplier: 2
                      random_factor: 0
                  value:
                    lock: '!inline delete_value_from_auxilius.inline_script.lock'
                    type: rawscript
                    content: '!inline delete_value_from_auxilius.inline_script.py'
                    language: python3
                    input_transforms:
                      at:
                        expr: results.step_0.token
                        type: javascript
                      uuid:
                        expr: flow_input.iter.value
                        type: javascript
                  summary: Delete value from auxilius
              iterator:
                expr: results.step_1.values
                type: javascript
              parallel: true
              parallelism:
                type: static
                value: 10
              skip_failures: true
            summary: Loop readings from values list.
          - id: step_9
            value:
              lock: '!inline break_the_current_loop.inline_script.lock'
              type: rawscript
              content: '!inline break_the_current_loop.inline_script.py'
              language: python3
              input_transforms:
                data:
                  expr: results.step_8
                  type: javascript
                truncated:
                  expr: results.step_1.truncated
                  type: javascript
            summary: Break the current loop
            stop_after_if:
              expr: result.break_while === true
              error_message: null
              skip_if_stopped: false
        skip_failures: false
      summary: Loop values lists
    - id: step_11
      value:
        lock: '!inline check_status_of_while_loop.inline_script.lock'
        type: rawscript
        content: '!inline check_status_of_while_loop.inline_script.py'
        language: python3
        input_transforms:
          data:
            expr: results.step_10
            type: javascript
      summary: Check status of while loop
